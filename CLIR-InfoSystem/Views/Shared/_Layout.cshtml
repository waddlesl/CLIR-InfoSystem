@using Microsoft.AspNetCore.Http
@{
    // Retrieve the user role from the session
    var role = Context.Session.GetString("UserRole");
    var currentAction = ViewContext.RouteData.Values["Action"]?.ToString();
    var currentController = ViewContext.RouteData.Values["Controller"]?.ToString();
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CLIR Library Management System</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="icon" type="image/x-icon" href="~/images/clirlogo.png" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        /* Shorter Top Banner */
        .top-banner {
            background-color: #1a2035;
            color: white;
            padding: 10px 20px; /* Shortened vertical padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1100;
        }

        .brand-text {
            font-size: 14px;
            line-height: 1.2;
            font-weight: bold;
        }

        /* Restored Default Logout */
        .logout-link {
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            transition: 0.3s;
        }

            .logout-link:hover {
                opacity: 0.7;
                color: #ff4d4d;
            }

        /* Hamburger Button */
        .hamburger {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            margin-right: 15px;
            display: flex;
            align-items: center;
        }

        /* Sidebar Layout */
        .wrapper {
            display: flex;
            position: relative;
        }

        .sidebar {
            width: 260px;
            background: #1a2035;
            min-height: calc(100vh - 55px);
            color: #b5b5b5;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 1000;
        }

            /* Toggle Class */
            .sidebar.collapsed {
                margin-left: -260px;
            }

        .nav-item {
            padding: 12px 20px;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }

            .nav-item a {
                color: inherit;
                text-decoration: none;
                display: block;
                width: 100%;
                font-size: 0.9rem;
            }

            .nav-item:hover, .nav-active {
                background: #2b3553;
                color: white !important;
                border-left: 4px solid #d92d20;
            }

        .main-content {
            flex: 1;
            padding: 40px;
            background: #f8f9fa;
            min-height: calc(100vh - 55px);
            transition: all 0.3s ease;
        }

        .logo {
            width: 45px;
            height: auto;
            margin-right: 10px;
        }

        .nav-group-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            padding: 15px 20px 5px 20px;
            color: #6e7a91;
            font-weight: bold;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 15px 20px;
            font-size: 0.8rem;
            color: #6e7a91;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div class="top-banner">
        <div class="d-flex align-items-center">
            <button class="hamburger" onclick="toggleSidebar()">☰</button>
            <img src="~/images/clirlogo.png" alt="Logo" class="logo" />
            <div class="brand-text">
                CENTER FOR LEARNING AND INFORMATION RESOURCES<br />
                <small style="font-weight: normal; opacity: 0.8; font-size: 11px;">MAPÚA MALAYAN COLLEGES LAGUNA</small>
            </div>
        </div>
        <a asp-controller="Account" asp-action="Logout" class="logout-link">Logout</a>
    </div>

    <div class="wrapper">
        <div class="sidebar" id="sidebar">
            <div class="nav-item @(currentAction == "Index" && currentController == "Dashboard" ? "nav-active" : "")">
                <a asp-controller="Dashboard" asp-action="Index">🏠 Home</a>
            </div>

            @if (role == "Admin")
            {
                <div class="nav-group-label">System Admin</div>
                <div class="nav-item"><a asp-controller="Account" asp-action="ManageStaff">👥 Manage Staffs</a></div>
                <div class="nav-item"><a asp-controller="Account" asp-action="AuditLogs">📋 Audit Logs</a></div>
                <div class="nav-item"><a asp-controller="Account" asp-action="SystemReports">📊 System Reports</a></div>
            }

            @if (role == "Librarian")
            {
                <div class="nav-group-label">Library Management</div>
                <div class="nav-item"><a asp-controller="Patron" asp-action="ManagePatrons">👤 Patron Management</a></div>
                <div class="nav-item"><a asp-controller="Book" asp-action="BookManagement">📚 Book Catalog</a></div>
                <div class="nav-item"><a asp-controller="Transaction" asp-action="BookBorrowers">🤝 Manage Borrowers</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="ManageBookings">🪑 Seat Reservations</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="ManageBookaLibrarian">👨‍🏫 Book A Librarian</a></div>
                <div class="nav-item"><a asp-controller="Service" asp-action="ManageODDS">📩 Digital Requests</a></div>
                <div class="nav-item"><a asp-controller="Service" asp-action="ManageServices">🛠️ Service Requests</a></div>
                <div class="nav-item"><a asp-controller="Report" asp-action="ReportDashboard">📈 Reports & Analytics</a></div>
            }

            @if (role == "Student Assistant")
            {
                <div class="nav-group-label">Assistant</div>
                <div class="nav-item"><a asp-controller="Patron" asp-action="ManagePatrons">👤 Patron Management</a></div>
                <div class="nav-item"><a asp-controller="Book" asp-action="BookManagement">📖 View Catalog</a></div>
                <div class="nav-item"><a asp-controller="Transaction" asp-action="BookBorrowers">🤝 View Borrowers</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="ManageBookings">🪑 View Reservations</a></div>
                <div class="nav-item"><a href="#">❓ Help Desk</a></div>
            }

            @if (role == "Patron")
            {
                <div class="nav-group-label">My Services</div>
                <div class="nav-item"><a asp-controller="Book" asp-action="PatronBorrow">📚 Borrow Books</a></div>
                <div class="nav-item"><a asp-controller="Transaction" asp-action="Index">📖 My Borrowings</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="BookASeat">🪑 Book a Seat</a></div>
                <div class="nav-item"><a asp-controller="Request" asp-action="ServiceRequest">🛠️ Service Request</a></div>
                <div class="nav-item"><a asp-controller="Request" asp-action="Odds">📄 Request Document</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="BookALibrarian">👨‍🏫 Book a Librarian</a></div>
                <div class="nav-item"><a asp-controller="Patron" asp-action="PatronActivity">📜 My Activity</a></div>
            }

            <div class="sidebar-footer">
                ⚙ Options
            </div>
        </div>

        <div class="main-content">
            @RenderBody()
        </div>
    </div>

    <script>
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Auto-collapse on small screens (like iPad in portrait)
        if (window.innerWidth < 992) {
            document.getElementById('sidebar').classList.add('collapsed');

        }


        var userRole = "@role";  // retrieved from session

        // Set timeout based on role
        var sessionTimeout = (userRole === "Patron") ? 10 * 60 : 15 * 60; // 10mins for Patrons, 15mins for others
        var idleTime = 0;

        function resetIdle() {
            idleTime = 0;
        }

        // Listen for any user activity
        document.onmousemove = resetIdle;
        document.onkeypress = resetIdle;
        document.ontouchstart = resetIdle;
        document.onclick = resetIdle;
        document.onscroll = resetIdle;

        // Check idle every second
        setInterval(() => {
            idleTime++;
            if (idleTime >= sessionTimeout) {
                alert("Your session has expired due to inactivity.");
                window.location.href = '/Account/Logout';
            }
        }, 1000);
    </script>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>