@using Microsoft.AspNetCore.Http
@{
    // Retrieve the user role from the session
    var role = Context.Session.GetString("UserRole");
    var currentAction = ViewContext.RouteData.Values["Action"]?.ToString();
    var currentController = ViewContext.RouteData.Values["Controller"]?.ToString();
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CLIR Library Management System</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="icon" type="image/x-icon" href="~/images/clirlogo.png" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        /* Shorter Top Banner */
        .top-banner {
            background-color: #1a2035;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1100;
        }

        .brand-text {
            font-size: 14px;
            line-height: 1.2;
            font-weight: bold;
        }

        .logout-link {
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .logout-link:hover {
            color: #ed1e28;
            opacity: 1;
        }

        .hamburger {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-right: 15px;
            display: flex;
            align-items: center;
        }

        /* Sidebar Layout */
        .wrapper {
            display: flex;
            position: relative;
        }

        .sidebar {
            width: 260px;
            background: #1a2035;
            min-height: calc(100vh - 55px);
            color: #b5b5b5;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar.collapsed {
            margin-left: -260px;
        }

        .nav-item {
            padding: 12px 20px;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
        }

            .nav-item a {
                color: inherit;
                text-decoration: none;
                display: block;
                width: 100%;
                font-size: 0.9rem;
            }

            /* Icon alignment and color */
            .nav-item i {
                width: 25px;
                text-align: center;
                margin-right: 10px;
                color: white;
            }

            .nav-item:hover, .nav-active {
                background: #2b3553;
                color: white !important;
                border-left: 4px solid #ed1e28;
            }

                .nav-item:hover i, .nav-active i {
                    color: white !important;
                }

        .main-content {
            flex: 1;
            padding: 40px;
            background: #f8f9fa;
            min-height: calc(100vh - 55px);
            transition: all 0.3s ease;
        }

        .logo {
            width: 45px;
            height: auto;
            margin-right: 10px;
        }

        .nav-group-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            padding: 20px 20px 5px 20px;
            color: #6e7a91;
            font-weight: bold;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 15px 20px;
            font-size: 0.8rem;
            color: #6e7a91;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        /*Drop down for yes*/
        .nav-sub-item-container .nav-link {
            font-size: 0.9rem;
            padding-left: 35px; 
            color: #b5b5b5;
        }

        .nav-sub-item-container .nav-link:hover {
            background: #2b3553;
            color: white !important;
            border-left: 4px solid #ed1e28;
        }

    </style>
</head>
<body>
    <div class="top-banner">
        <div class="d-flex align-items-center">
            <button class="hamburger" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            <img src="~/images/clirlogo.png" alt="Logo" class="logo" />
            <div class="brand-text">
                CENTER FOR LEARNING AND INFORMATION RESOURCES<br />
                <small style="font-weight: normal; opacity: 0.8; font-size: 11px;">MAPÚA MALAYAN COLLEGES LAGUNA</small>
            </div>
        </div>
        <a asp-controller="Account" asp-action="Logout" class="logout-link">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
        </a>
    </div>

    <div class="wrapper">
        <div class="sidebar" id="sidebar">
            <div class="nav-item @(currentAction == "Index" && currentController == "Dashboard" ? "nav-active" : "")">
                <a asp-controller="Dashboard" asp-action="Index"><i class="fa-solid fa-house"></i> Home</a>
            </div>

            @if (role == "Admin")
            {
                <div class="nav-group-label">System Admin</div>
                <div class="nav-item"><a asp-controller="Account" asp-action="ManageStaff"><i class="fa-solid fa-users-gear"></i> Manage Staffs</a></div>
                <div class="nav-item"><a asp-controller="Account" asp-action="AuditLogs"><i class="fa-solid fa-clipboard-check"></i> Audit Logs</a></div>
                <div class="nav-item"><a asp-controller="Account" asp-action="SystemReports"><i class="fa-solid fa-chart-line"></i> System Reports</a></div>
            }

            @if (role == "Librarian")
            {
                bool isBorrowerMenuOpen = currentController == "Transaction";
                <div class="nav-item"><a asp-controller="Patron" asp-action="ManagePatrons"><i class="fa-solid fa-user-tag"></i> Patron Management</a></div>
                <div class="nav-item"><a asp-controller="Book" asp-action="BookManagement"><i class="fa-solid fa-book-bookmark"></i> Book Catalog</a></div>
                <div class="nav-item"><a asp-controller="Transaction" asp-action="BookBorrowers"><i class="fa-solid fa-handshake"></i> Book Borrowers</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="BookingsHistory"><i class="fa-solid fa-chair"></i> Seat Reservations</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="ManageBookaLibrarian"><i class="fa-solid fa-chalkboard-user"></i> Book A Librarian</a></div>
                <div class="nav-item"><a asp-controller="Service" asp-action="ManageODDS"><i class="fa-solid fa-envelope-open-text"></i> Digital Requests</a></div>
                <div class="nav-item"><a asp-controller="Service" asp-action="ManageServices"><i class="fa-solid fa-screwdriver-wrench"></i> Service Requests</a></div>
                }

            @if (role == "Student Assistant")
            {
                <div class="nav-group-label">Assistant</div>
                <div class="nav-item"><a asp-controller="Patron" asp-action="ManagePatrons"><i class="fa-solid fa-users"></i> Patron Management</a></div>
                <div class="nav-item"><a asp-controller="Book" asp-action="BookManagement"><i class="fa-solid fa-book-open"></i> View Catalog</a></div>
                <div class="nav-item"><a asp-controller="Transaction" asp-action="BookBorrowers"><i class="fa-solid fa-hand-holding-hand"></i> View Borrowers</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="ManageBookings"><i class="fa-solid fa-calendar-check"></i> View Reservations</a></div>
            }

            @if (role == "Student Assistant" || role == "Librarian")
            {
                <div class="nav-item"><a asp-controller="Report" asp-action="ReportDashboard"><i class="fa-solid fa-chart-pie"></i> Reports & Analytics</a></div>

            }

            @if (role == "Patron")
            {
                <div class="nav-group-label">My Services</div>
                <div class="nav-item"><a asp-controller="Book" asp-action="PatronBorrow"><i class="fa-solid fa-book-medical"></i> Borrow Books</a></div>
                <div class="nav-item"><a asp-controller="Transaction" asp-action="Index"><i class="fa-solid fa-book-reader"></i> My Borrowings</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="BookASeat"><i class="fa-solid fa-couch"></i> Book a Seat</a></div>
                <div class="nav-item"><a asp-controller="Request" asp-action="ServiceRequest"><i class="fa-solid fa-gears"></i> Service Request</a></div>
                <div class="nav-item"><a asp-controller="Request" asp-action="Odds"><i class="fa-solid fa-file-pdf"></i> Request Document</a></div>
                <div class="nav-item"><a asp-controller="Facility" asp-action="BookALibrarian"><i class="fa-solid fa-person-chalkboard"></i> Book a Librarian</a></div>
                <div class="nav-item"><a asp-controller="Patron" asp-action="PatronActivity"><i class="fa-solid fa-receipt"></i> My Activity</a></div>
            }

            <div class="sidebar-footer">
                <i class="fa-solid fa-gear"></i> Options
            </div>
        </div>

        <div class="main-content">
            @RenderBody()
        </div>
    </div>

    <script>
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        if (window.innerWidth < 992) {
            document.getElementById('sidebar').classList.add('collapsed');
        }

        var userRole = "@role";
        var sessionTimeout = (userRole === "Patron") ? 10 * 60 : 15 * 60;
        var idleTime = 0;

        function resetIdle() {
            idleTime = 0;
        }

        document.onmousemove = resetIdle;
        document.onkeypress = resetIdle;
        document.ontouchstart = resetIdle;
        document.onclick = resetIdle;
        document.onscroll = resetIdle;

        setInterval(() => {
            idleTime++;
            if (idleTime >= sessionTimeout) {
                alert("Your session has expired due to inactivity.");
                window.location.href = '/Account/Logout';
            }
        }, 1000);
    </script>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>