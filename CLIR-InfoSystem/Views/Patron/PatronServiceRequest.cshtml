@model CLIR_InfoSystem.Models.ServiceRequest

@{
    bool alreadyRequested = ViewBag.AlreadyRequested ?? false;
}

<style>
    .request-card {
        max-width: 600px;
        margin: 50px auto;
        border-radius: 18px;
        border: none;
    }

    .card-header-custom {
        text-align: center;
        padding: 30px 20px 10px;
    }

    .card-body-custom {
        padding: 30px 40px 40px;
    }

    .form-group label {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #6c757d;
        margin-bottom: 8px;
        display: block;
        letter-spacing: 0.5px;
    }

    .display-field {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        color: #333;
        font-weight: 500;
    }

    .btn-submit {
        background-color: #198754;
        color: white;
        border: none;
        padding: 12px 0;
        border-radius: 8px;
        font-weight: bold;
        transition: all 0.2s;
        width: 100%;
    }

        .btn-submit:hover {
            background-color: #157347;
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
        }

    .alert-success-custom {
        background-color: #d1e7dd;
        border: none;
        color: #0f5132;
        border-radius: 10px;
        padding: 20px;
    }
</style>

<div class="container d-flex justify-content-center">
    <div class="card shadow-sm request-card">

        <!-- HEADER -->
        <div class="card-header-custom">
            <h4 class="fw-bold mb-1">Request Service Access</h4>
            <small class="text-muted d-block">
                @DateTime.Now.ToString("MMM dd, yyyy | dddd, h:mm tt")
            </small>
        </div>

        <div class="card-body-custom">

            <!-- SUCCESS MESSAGE -->
            <div id="successMessage" class="alert-success-custom text-center"
                 style="@(alreadyRequested ? "display:block;" : "display:none;")">
                <i class="bi bi-check-circle-fill d-block mb-2" style="font-size: 2rem;"></i>
                <h5 class="fw-bold">Request Submitted!</h5>
                <p class="small mb-0">
                    Your request for <strong id="selectedServiceName"></strong> is being processed.
                    Please check your email (@Context.Session.GetString("UserEmail")) for the invitation link shortly.
                </p>
                <hr>
                <a href="/Dashboard/PatronDashboard" class="btn btn-sm btn-outline-success border-0 fw-bold">
                    Return to Dashboard
                </a>
            </div>

            <!-- FORM -->
            @if (!alreadyRequested)
            {
                <form id="serviceForm">

                    <input type="hidden" name="PatronId"
                           value="@Context.Session.GetString("UserId")" />

                    <!-- SERVICE DROPDOWN -->
                    <div class="form-group mb-3">
                        <label>Select Service Type</label>
                        <select name="ServiceType" class="form-control" required>
                            <option value="">-- Select Service --</option>
                            <option value="Grammarly">Grammarly</option>
                            <option value="Turnitin">Turnitin</option>
                        </select>
                    </div>

                    <!-- USER INFO -->
                    <div class="form-group">
                        <label>Patron Identification</label>
                        <div class="display-field">
                            @Context.Session.GetString("UserId")
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Confirmation Email</label>
                        <div class="display-field">
                            @Context.Session.GetString("UserEmail")
                        </div>
                    </div>

                    <!-- TERMS CHECKBOX -->
                    <div class="form-check mb-4">
                        <input class="form-check-input"
                               type="checkbox"
                               id="academicCheck"
                               required>
                        <label class="form-check-label small text-muted"
                               for="academicCheck">
                            I understand that this access is granted for
                            <strong>academic and research use only</strong>.
                        </label>
                    </div>

                    <button type="button"
                            onclick="submitService()"
                            class="btn btn-submit">
                        SUBMIT REQUEST
                    </button>

                </form>
            }
        </div>

        <!-- FOOTER -->
        <div class="card-footer bg-white border-0 text-center py-3 small text-muted">
            Library Service Access System
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function submitService() {

        const checkbox = document.getElementById('academicCheck');
        const form = document.getElementById('serviceForm');
        const successBox = document.getElementById('successMessage');
        const serviceSelect = form.querySelector("select[name='ServiceType']");
        const selectedService = serviceSelect.value;

        // Validate Service Selection
        if (!selectedService) {
            Swal.fire({
                icon: 'warning',
                title: 'Service Required',
                text: 'Please select a service type.',
                confirmButtonColor: '#198754'
            });
            return;
        }

        // Validate Checkbox
        if (!checkbox.checked) {
            Swal.fire({
                icon: 'warning',
                title: 'Terms Required',
                text: 'Please check the academic use box to proceed.',
                confirmButtonColor: '#198754'
            });
            return;
        }

        const formData = new FormData(form);

        fetch('/Request/SubmitServiceRequest', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {

                form.style.display = 'none';
                successBox.style.display = 'block';

                document.getElementById("selectedServiceName")
                        .innerText = selectedService;

                Swal.fire({
                    icon: 'success',
                    title: 'Submitted!',
                    showConfirmButton: false,
                    timer: 1500
                });

            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Failed',
                    text: 'You may already have a pending request for this service.',
                    confirmButtonColor: '#dc3545'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Could not connect to the server.'
            });
        });
    }
</script>
