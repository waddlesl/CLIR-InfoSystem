@model CLIR_InfoSystem.Models.OddsRequest
@{
    bool alreadyRequested = ViewBag.AlreadyRequested ?? false;
    // Assuming you pass the count from the controller
    int currentCount = ViewBag.TodayCount ?? 0;
    int maxLimit = 5;
}

<style>
    /* 1. Main Card Styling */
    .odds-card {
        max-width: 800px;
        margin: 50px auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: none;
        overflow: hidden;
    }

    .card-header-custom {
        padding: 40px 20px 10px;
        text-align: center;
    }

    .card-body-custom {
        padding: 30px 50px 50px;
    }

    /* 2. Form Labels & Inputs */
    .form-group label {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #6c757d;
        margin-bottom: 8px;
        display: block;
        letter-spacing: 0.5px;
    }

    .form-select, .form-control {
        border-radius: 8px;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        transition: border-color 0.2s;
    }

        .form-select:focus, .form-control:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.1);
        }

    /* 3. Alerts & Quota */
    .alert-custom {
        border-radius: 12px;
        border: none;
        padding: 20px;
    }

    .quota-badge {
        background: #e9ecef;
        color: #495057;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
</style>

<div class="container">
    <div class="odds-card">
        <div class="card-header-custom">
            <div class="d-flex justify-content-center mb-3">
                <span class="quota-badge">Daily Limit: @currentCount / @maxLimit Requests Today</span>
            </div>
            <h2 class="fw-bold mb-0">Online Document Delivery Service</h2>
            <p class="text-muted small mt-2">Request digital copies of library materials</p>
        </div>

        <div class="card-body-custom">
            @* SUCCESS MESSAGE (Hidden by default, shown via JS) *@
            <div id="successContainer" class="alert alert-success alert-custom text-center shadow-sm" style="display:none;">
                <i class="bi bi-check-circle-fill d-block mb-2" style="font-size: 2.5rem;"></i>
                <h4 class="fw-bold">Request Submitted!</h4>
                <p class="mb-3">Your document request is being processed. Check your email for updates.</p>
                <hr>
                <button onclick="location.reload()" class="btn btn-success fw-bold px-4">Make Another Request</button>
            </div>

            @* REQUEST FORM *@
            <form id="oddsForm" style="@(currentCount >= maxLimit ? "display:none;" : "display:block;")">
                <input type="hidden" asp-for="PatronId" value="@Context.Session.GetString("UserId")" />

                <div class="row mb-4">
                    <div class="col-md-6 form-group">
                        <label>Type of Material</label>
                        <select class="form-select" asp-for="MaterialType" required>
                            <option value="E-Book">E-Book</option>
                            <option value="Journal Article">Journal Article</option>
                            <option value="Thesis">Thesis</option>
                            <option value="Conference Paper">Conference Paper</option>
                        </select>
                    </div>
                    <div class="col-md-6 form-group">
                        <label>Type of Service</label>
                        <select class="form-select" asp-for="ServiceType" required>
                            <option value="Scanning">Scanning</option>
                            <option value="PDF Delivery">PDF Delivery</option>
                            <option value="Resource Link">Resource Link</option>
                        </select>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label>Select Book/Material (Optional)</label>
                    <select class="form-select" asp-for="AccessionId">
                        <option value="">-- Select Title from Library Collection --</option>
                        @if (ViewBag.Books != null)
                        {
                            foreach (var book in ViewBag.Books)
                            {
                                <option value="@book.AccessionId">@book.Title (@book.AccessionId)</option>
                            }
                        }
                    </select>
                </div>

                <div class="form-group mb-5">
                    <label>External Resource URL</label>
                    <input type="url" class="form-control" asp-for="ResourceLink" placeholder="https://example.com/article-link" />
                    <small class="text-muted">Provide a link if the material is from an external database.</small>
                </div>

                <div class="d-grid">
                    <button type="button" onclick="submitOddsRequest()" class="btn btn-success fw-bold py-3">SUBMIT REQUEST</button>
                </div>
            </form>

            @* LIMIT REACHED MESSAGE *@
            @if (currentCount >= maxLimit)
            {
                <div class="alert alert-warning alert-custom text-center shadow-sm">
                    <i class="bi bi-exclamation-octagon d-block mb-2" style="font-size: 2.5rem;"></i>
                    <h5 class="fw-bold">Daily Limit Reached</h5>
                    <p>You have already submitted @maxLimit requests today. Please come back tomorrow!</p>
                    <a href="/Dashboard/PatronDashboard" class="btn btn-outline-secondary btn-sm mt-2">Back to Dashboard</a>
                </div>
            }
        </div>
    </div>
</div>

@* JS Logic for Feedback *@
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function submitOddsRequest() {
        const form = document.getElementById('oddsForm');
        const successBox = document.getElementById('successContainer');
        const formData = new FormData(form);

        fetch('/Request/SubmitOdds', {
            method: 'POST',
            body: formData
        })
        .then(async response => {
            if (response.ok) {
                form.style.display = 'none';
                successBox.style.display = 'block';
                Swal.fire({
                    icon: 'success',
                    title: 'Submitted Successfully',
                    showConfirmButton: false,
                    timer: 1500
                });
            } else {
                const errorText = await response.text();
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Failed',
                    text: errorText || 'Please check your inputs and try again.'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({ icon: 'error', title: 'Network Error' });
        });
    }
</script>