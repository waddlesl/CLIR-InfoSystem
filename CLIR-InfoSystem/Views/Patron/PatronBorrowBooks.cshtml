@model IEnumerable<CLIR_InfoSystem.Models.Book>

<div class="container mt-3">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="fw-bold mb-0">Book Borrowing</h4>
            <small class="text-muted">
                @DateTime.Now.ToString("MMM dd, yyyy | dddd, h:mm tt")
            </small>
        </div>

        <!-- SEARCH -->
        <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search text-muted"></i>
            </span>
            <input type="text"
                   id="catalogSearch"
                   class="form-control border-start-0"
                   placeholder="Search (Acc No. or Title)">
        </div>
    </div>

    <!-- CARD -->
    <div class="card shadow-sm border-0">

        <div class="card-body p-4">

            <!-- TABLE -->
            <div class="table-responsive">
                <table class="table align-middle mb-0" id="bookTable">
                    <thead class="small text-muted">
                        <tr>
                            <th>Acc No.</th>
                            <th>Book Title</th>
                            <th>Author</th>
                            <th>Collection</th>
                            <th>Location</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody id="bookTableBody">
                        @foreach (var book in Model)
                        {
                            <tr>
                                <td class="small">@book.AccessionId</td>
                                <td class="fw-semibold">@book.Title</td>
                                <td>@book.Author</td>
                                <td>@book.Collection</td>
                                <td>@book.LibraryLocation</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-success px-3"
                                            onclick="confirmBorrow('@book.AccessionId', '@book.Title')">
                                        Borrow
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

        </div>

        <!-- FOOTER AREA -->
        <div class="card-footer bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center">

                <!-- PAGE INFO LEFT -->
                <div id="pageInfo" class="small text-muted"></div>

                <!-- PAGINATION RIGHT -->
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>

            </div>
        </div>

    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let rowsPerPage = 10;
        let currentPage = 1;

        function updateTable() {
            let rows = $("#bookTableBody tr:not(.filtered)");
            let totalRows = rows.length;
            let totalPages = Math.ceil(totalRows / rowsPerPage);

            $("#bookTableBody tr").hide();
            
            let start = (currentPage - 1) * rowsPerPage;
            let end = start + rowsPerPage;

            rows.slice(start, end).show();

            // Page Info
            $("#pageInfo").text(`Showing ${totalRows > 0 ? start + 1 : 0} to ${Math.min(end, totalRows)} of ${totalRows} entries`);

            // Generate Pagination
            let paginationHtml = "";
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>
                </li>`;
            }
            $("#pagination").html(paginationHtml);
        }

        function goToPage(page) {
            currentPage = page;
            updateTable();
        }

        // Real-time Search
        $("#catalogSearch").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#bookTableBody tr").each(function() {
                let isMatch = $(this).text().toLowerCase().indexOf(value) > -1;
                $(this).toggleClass("filtered", !isMatch);
            });
            currentPage = 1;
            updateTable();
        });

        // Initialize
        $(document).ready(function() {
            updateTable();
        });

        function confirmBorrow(accId, title) {
            Swal.fire({
                title: 'Borrow this book?',
                text: `You are requesting to borrow "${title}".`,
                icon: 'question',
                input: 'text',
                inputPlaceholder: 'Enter your Patron ID',
                showCancelButton: true,
                confirmButtonColor: '#198754',
                confirmButtonText: 'Confirm'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    $.post('/Book/ProcessBorrow', { 
                        accessionId: accId, 
                        patronId: result.value 
                    }, function(res) {
                        if(res.success) {
                            Swal.fire("Success", res.message, "success").then(() => location.reload());
                        } else {
                            Swal.fire("Error", res.message, "error");
                        }
                    });
                }
            });
        }
    </script>
    <style>
        .page-link { color: #1a2035; }
        .page-item.active .page-link {
            background-color: #1a2035;
            border-color: #1a2035;
            color: white;
        }
    </style>
}