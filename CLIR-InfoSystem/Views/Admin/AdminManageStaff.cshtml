@model IEnumerable<CLIR_InfoSystem.Models.Staff>

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <h2 class="fw-bold" style="color: #1a2035;">Staff Management</h2>

        <div class="d-flex gap-2">
            <form autocomplete="off">
                <div class="input-group" style="width: 350px;">
                    <input type="text" id="staffSearch" placeholder="Search by ID or Username..." class="form-control" autocomplete="off" />
                </div>
            </form>

            <button type="button" class="btn btn-success px-3" onclick="openAddModal()">
                <b>+</b> Add Staff
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table align-middle mb-0" id="staffTable">
                    <thead class="small text-muted">
                        <tr>
                            <th>Staff ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Role</th>
                            <th>Username</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffTableBody">
                        @foreach (var staff in Model)
                        {
                            <tr style="@(staff.Status == "Inactive" ? "opacity: 0.6;" : "")">
                                <td class="small">@staff.StaffId</td>
                                <td class="fw-semibold">@staff.FirstName</td>
                                <td>@staff.LastName</td>
                                <td>@staff.TypeOfUser</td>
                                <td>@staff.Username</td>
                                <td>
                                    <span class="badge @(staff.Status == "Active" ? "bg-success" : "bg-secondary")">
                                        @staff.Status
                                    </span>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm px-3 text-white" style="background-color: #1e2953;" onclick="openEditModal(@staff.StaffId)">
                                        Edit
                                    </button>

                                    <button class="btn btn-sm px-3 @(staff.Status == "Active" ? "" : "btn-success")"
                                            style="@(staff.Status == "Active" ? "border: 1px solid #ec1e28; color: #ec1e28; background-color: white;" : "")"
                                            onclick="confirmToggle(@staff.StaffId, '@(staff.Status == "Active" ? "Archive" : "Activate")')">
                                        @(staff.Status == "Active" ? "Archive" : "Activate")
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Staff</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="addFirst" class="form-control mb-2" placeholder="First Name" />
                        <input type="text" id="addLast" class="form-control mb-2" placeholder="Last Name" />
                        <input type="text" id="addUser" class="form-control mb-2" placeholder="Username" />
                        <input type="password" id="addPass" class="form-control mb-2" placeholder="Password" />
                        <select id="addRole" class="form-select">
                            <option value="Librarian">Librarian</option>
                            <option value="Student Assistant">Student Assistant</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="createStaff()">Create</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Staff</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editId" />
                        <input type="text" id="editFirst" class="form-control mb-2" placeholder="First Name" />
                        <input type="text" id="editLast" class="form-control mb-2" placeholder="Last Name" />
                        <input type="text" id="editUser" class="form-control mb-2" placeholder="Username" />
                        <input type="password" id="editPass" class="form-control mb-2" placeholder="New Password (optional)" />
                        <select id="editRole" class="form-select">
                            <option value="Librarian">Librarian</option>
                            <option value="Student Assistant">Student Assistant</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="updateStaff()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer bg-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div id="pageInfo" class="small text-muted"></div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let rowsPerPage = 10;
        let currentPage = 1;

        $(document).ready(function() {
            updateTable();

            var alertMsg = '@TempData["AlertMessage"]';
            if (alertMsg) {
                Swal.fire({
                    icon: alertMsg.includes('cannot') || alertMsg.includes('denied') ? 'warning' : 'success',
                    title: 'System Notification',
                    text: alertMsg,
                    confirmButtonColor: '#1e2953'
                });
            }
        });

        function updateTable() {
            let rows = $("#staffTableBody tr:not(.filtered)");
            let totalRows = rows.length;
            let totalPages = Math.ceil(totalRows / rowsPerPage);

            $("#staffTableBody tr").hide();
            let start = (currentPage - 1) * rowsPerPage;
            let end = start + rowsPerPage;

            rows.slice(start, end).show();

            $("#pageInfo").text(`Showing ${totalRows > 0 ? start + 1 : 0} to ${Math.min(end, totalRows)} of ${totalRows} entries`);

            let paginationHtml = "";
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>
                </li>`;
            }
            $("#pagination").html(paginationHtml);
        }

        function goToPage(page) {
            currentPage = page;
            updateTable();
        }

        $("#staffSearch").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#staffTableBody tr").each(function() {
                let isMatch = $(this).text().toLowerCase().indexOf(value) > -1;
                $(this).toggleClass("filtered", !isMatch);
            });
            currentPage = 1;
            updateTable();
        });

        function openAddModal() {
            $('#addFirst, #addLast, #addUser, #addPass').val('');
            new bootstrap.Modal(document.getElementById('addModal')).show();
        }

        function openEditModal(id) {
            $.get('/Account/GetStaffDetails/' + id, function(data) {
                $('#editId').val(data.staffId);
                $('#editFirst').val(data.firstName);
                $('#editLast').val(data.lastName);
                $('#editUser').val(data.username);
                $('#editRole').val(data.typeOfUser);
                $('#editPass').val('');
                new bootstrap.Modal(document.getElementById('editModal')).show();
            });
        }

        function createStaff() {
            const data = {
                FirstName: $('#addFirst').val(),
                LastName: $('#addLast').val(),
                Username: $('#addUser').val(),
                Password: $('#addPass').val(),
                TypeOfUser: $('#addRole').val(),
                Status: 'Active'
            };
            submitStaffData('/Account/AddStaff', data);
        }

        function updateStaff() {
            const data = {
                StaffId: parseInt($('#editId').val()),
                FirstName: $('#editFirst').val(),
                LastName: $('#editLast').val(),
                Username: $('#editUser').val(),
                Password: $('#editPass').val(),
                TypeOfUser: $('#editRole').val()
            };
            submitStaffData('/Account/UpdateStaff', data);
        }

        function submitStaffData(url, data) {
            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (res) {
                    if (res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Staff record updated successfully.',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => location.reload());
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Validation Error',
                            text: res.message,
                            confirmButtonColor: '#1e2953'
                        });
                    }
                },
                error: function () {
                    Swal.fire('Error', 'Server connection failed.', 'error');
                }
            });
        }

        function confirmToggle(id, action) {
            Swal.fire({
                title: 'Are you sure?',
                text: `Do you want to ${action} this staff member?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#1e2953',
                cancelButtonColor: '#ec1e28',
                confirmButtonText: `Yes, ${action}!`
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/Account/ToggleStatus/' + id;
                }
            });
        }
    </script>

    <style>
        .page-link {
            color: #1a2035;
        }

        .page-item.active .page-link {
            background-color: #1a2035 !important;
            border-color: #1a2035 !important;
            color: white !important;
        }
    </style>
}