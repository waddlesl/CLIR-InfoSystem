@model IEnumerable<CLIR_InfoSystem.Models.BookBorrowing>

<div class="container-fluid px-4 mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="fw-bold mb-0">Borrower History</h4>
            <small class="text-muted">
                @DateTime.Now.ToString("MMM dd, yyyy | dddd, h:mm tt")
            </small>
        </div>

        <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search text-muted"></i>
            </span>
            <input type="text"
                   id="borrowSearch"
                   class="form-control border-start-0"
                   placeholder="Search Borrow Requests">
        </div>
    </div>
<div id="bm-page-container">
    <div class="card p-3 shadow-sm border-0">

        <div class="table-responsive">
            <table class="table align-middle text-center">
                <thead>
                    <tr>
                        <th>Borrow ID</th>
                        <th>Name</th>
                        <th>Book Title</th>
                        <th>Date Requested</th>
                        <th>Date Returned</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="borrowHisroryTable">
                    @{
                        var allRequests = Model.Where(BookBorrowing => BookBorrowing.Status == "Returned" || BookBorrowing.Status == "Denied");
                    }


                    @if (!allRequests.Any())
                    {
                        <tr>
                            <td colspan="6">
                                <em>No borrower requests found.</em>
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var bb in allRequests)
                        {
                            <tr>
                                <td>@bb.BorrowId</td>
                                <td>@(bb.Patron?.FirstName + " " + bb.Patron?.LastName)</td>
                                <td>@(bb.Book?.Title ?? "No Title")</td>
                                <td>@(bb.BorrowDate.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                <td>@(bb.ReturnDate?.ToString("yyyy-MM-dd")?? "N/A")</td>
                                <td>
                                    @{
                                        string badgeClass = bb.Status switch
                                        {
                                            "Returned" => "bg-success",
                                            "Denied" => "bg-danger",
                                            _ => "bg-secondary"
                                        };
                                    }
                                    <span class="badge @badgeClass">@bb.Status</span>
                                    </td>
                            </tr>
                        }

                    }
                        </tbody>                
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center">

            <!-- PAGE INFO LEFT -->
            <div id="pageInfo" class="small text-muted"></div>

            <!-- PAGINATION RIGHT -->
            <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>

        </div>
    </div>
</div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let rowsPerPage = 10;
        let currentPage = 1;

        function updateTable() {
            let rows = $("#borrowHisroryTable tr:not(.filtered)");
            let totalRows = rows.length;
            let totalPages = Math.ceil(totalRows / rowsPerPage);

            $("#borrowHisroryTable tr").hide();

            let start = (currentPage - 1) * rowsPerPage;
            let end = start + rowsPerPage;

            rows.slice(start, end).show();

            // Page Info
            $("#pageInfo").text(`Showing ${totalRows > 0 ? start + 1 : 0} to ${Math.min(end, totalRows)} of ${totalRows} entries`);

            // Generate Pagination
            let paginationHtml = "";
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>
                        </li>`;
            }
            $("#pagination").html(paginationHtml);
        }

        function goToPage(page) {
            currentPage = page;
            updateTable();
        }

        // Real-time Search
        $("#borrowSearch").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#borrowHisroryTable tr").each(function() {
                let isMatch = $(this).text().toLowerCase().indexOf(value) > -1;
                $(this).toggleClass("filtered", !isMatch);
            });
            currentPage = 1;
            updateTable();
        });

        // Initialize
        $(document).ready(function() {
            updateTable();
        });

    </script>
    <style>
        .page-link {
            color: #1a2035;
        }

        .page-item.active .page-link {
            background-color: #1a2035;
            border-color: #1a2035;
            color: white;
        }
    </style>
}
