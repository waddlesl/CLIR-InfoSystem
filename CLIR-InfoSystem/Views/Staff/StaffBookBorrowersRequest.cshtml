@model IEnumerable<CLIR_InfoSystem.Models.BookBorrowing>
<div class="container-fluid px-4 mt-3">

    @if (ViewBag.IsStudentAssistant == false)
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h4 class="fw-bold mb-0">Borrower Request</h4>
                <small class="text-muted">
                    @DateTime.Now.ToString("MMM dd, yyyy | dddd, h:mm tt")
                </small>
            </div>

            <div class="input-group" style="max-width: 300px;">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text"
                       id="borrowRequestSearch"
                       class="form-control border-start-0"
                       placeholder="Search Borrow Requests">
            </div>
        </div>
        <div class="card p-3 shadow-sm border-0">
                <div class="table-responsive">
                <table class="table align-middle text-center">
                        <thead class="small text-muted">
                            <tr>
                                <th>Borrow ID</th>
                                <th>Name</th>
                                <th>Book Title</th>
                                <th>Request Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                    <tbody id="borrowRequestTable">
                            @{
                                var reservedRequests2 = Model?.Where(bb => bb.Status == "Reserved").ToList()
                                ?? new List<CLIR_InfoSystem.Models.BookBorrowing>();
                            }
                            @if (!reservedRequests2.Any())
                            {
                                <tr>
                                    <td colspan="5" style="text-align: center;">
                                        <em>No borrower requests found.</em>
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var bb in reservedRequests2)
                                {
                                    <tr>
                                        <td>@bb.BorrowId</td>
                                        <td>@(bb.Patron?.FirstName + " " + bb.Patron?.LastName)</td>
                                        <td>@(bb.Book?.Title ?? "No Title")</td>
                                        <td>@bb.BorrowDate.ToString("yyyy-MM-dd")</td>
                                        @if (ViewBag.IsStudentAssistant == false)
                                        {
                                            <td>
                                                <button class="btn btn-sm btn-success" onclick="confirmToggle('@bb.BorrowId','confirm')">Confirm</button> |
                                            <button class="btn btn-sm btn-danger" onclick="confirmToggle('@bb.BorrowId', 'deny')">Deny</button>
                                            </td>
                                        }
                                        else
                                        {
                                            <td>
                                                <button class="btn btn-sm btn-secondary" disabled>Confirm</button> | <button class="btn btn-sm btn-secondary" disabled>Deny</button>
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <!-- PAGE INFO LEFT -->
                    <div id="pageInfo" class="small text-muted"></div>

                    <!-- PAGINATION RIGHT -->
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                    </nav>
                </div>
            
        </div>
    }
</div>



@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

        function confirmRequest(id) {
           
            processRequest('/Book/ConfirmRequest', id);
        }

        function denyRequest(id) {
            processRequest('/Book/DenyRequest', id);
        }
        let rowsPerPage = 10;
        let currentPage = 1;

        function updateTable() {
            let rows = $("#borrowRequestTable tr:not(.filtered)");
            let totalRows = rows.length;
            let totalPages = Math.ceil(totalRows / rowsPerPage);

            $("#borrowRequestTable tr").hide();

            let start = (currentPage - 1) * rowsPerPage;
            let end = start + rowsPerPage;

            rows.slice(start, end).show();

            // Page Info
            $("#pageInfo").text(`Showing ${totalRows > 0 ? start + 1 : 0} to ${Math.min(end, totalRows)} of ${totalRows} entries`);

            // Generate Pagination
            let paginationHtml = "";
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>
                                </li>`;
            }
            $("#pagination").html(paginationHtml);
        }

        function goToPage(page) {
            currentPage = page;
            updateTable();
        }

        // Real-time Search
        $("#borrowRequestSearch").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#borrowRequestTable tr").each(function() {
                let isMatch = $(this).text().toLowerCase().indexOf(value) > -1;
                $(this).toggleClass("filtered", !isMatch);
            });
            currentPage = 1;
            updateTable();
        });

        // Initialize
        $(document).ready(function() {
            updateTable();
        });

        function confirmToggle(id, nextStatus) {
            Swal.fire({
                title: 'Confirm Action?',
                text: `Are you sure you want to ${nextStatus} this borrow?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Yes, ${nextStatus} it.`
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/Transaction/ToggleAvailability?id=${id}&status=${nextStatus}`;
                }
            });
        }

    </script>
    <style>
        .page-link {
            color: #1a2035;
        }

        .page-item.active .page-link {
            background-color: #1a2035;
            border-color: #1a2035;
            color: white;
        }
    </style>
}
