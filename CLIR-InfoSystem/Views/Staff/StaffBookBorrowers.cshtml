@model IEnumerable<CLIR_InfoSystem.Models.BookBorrowing>
<div class="container-fluid px-4 mt-3">

    <div class="report-tabs d-flex gap-2 p-1 bg-light rounded-pill" style="width: fit-content; border: 1px solid #dee2e6;">
        <a asp-controller="Transaction" asp-action="BookBorrowers"
           class="nav-link px-4 py-2 rounded-pill fw-bold transition-all @(ViewContext.RouteData.Values["action"]?.ToString() == "BookBorrowers" ? "active-tab" : "text-muted")">
            <i class="bi bi-envelope-open me-2"></i>Current Borrowers
        </a>
        @if (ViewBag.IsStudentAssistant == false)
        {
            <a asp-controller="Transaction" asp-action="BookBorrowersRequest"
            class="nav-link px-4 py-2 rounded-pill fw-bold transition-all @(ViewContext.RouteData.Values["action"]?.ToString() == "BookBorrowersRequest" ? "active-tab" : "text-muted")">
                <i class="bi bi-clock-history me-2"></i>Borrow Requests
            </a>            
        }
        <a asp-controller="Transaction" asp-action="BorrowersHistory"
           class="nav-link px-4 py-2 rounded-pill fw-bold transition-all @(ViewContext.RouteData.Values["action"]?.ToString() == "BorrowersHistory" ? "active-tab" : "text-muted")">
            <i class="bi bi-clock-history me-2"></i>Borrow History
        </a>


    </div>
    <div class="row g-4 mt-1">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm p-3" style="border-left: 5px solid #ed1e28 !important;">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <i class="fa-solid fa-hand-holding-hand fa-2x" style="color: #ed1e28; opacity: 0.8;"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1 small text-uppercase fw-bold">Borrowed</h6>
                        <h3 class="mb-0">@ViewBag.BorrowedBookCount</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm p-3" style="border-left: 5px solid #ed1e28 !important;">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <i class="fa-solid fa-exclamation fa-2x" style="color: #ed1e28; opacity: 0.8;"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1 small text-uppercase fw-bold">Overdued Books</h6>
                        <h3 class="mb-0">@ViewBag.OverdueBookCount</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br/>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="fw-bold mb-0" style="color: #1a2035; font-size: 1.1rem;">Current Borrowers</h5>
            <small class="text-muted">
                @DateTime.Now.ToString("MMM dd, yyyy | dddd, h:mm tt")
            </small>
        </div>

        <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search text-muted"></i>
            </span>
            <input type="text"
                   id="borrowSearch"
                   class="form-control border-start-0"
                   placeholder="Search Borrow Requests">
        </div>
    </div>
  
        <div class="card p-3 shadow-sm border-0">
            <div class="table-responsive">
                <table class="table align-middle text-center">
                    <thead>
                        <tr>
                            <th>Borrow ID</th>
                            <th>Name</th>
                            <th>Book Title</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Fee</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                <tbody id="currentBorrowerTable">
                        @{
                            var allRequests = Model.Where(bb => bb.Status == "Borrowed" || bb.Status == "Overdue");
                        }

                        @if (!allRequests.Any())
                        {
                            <tr>
                                <td colspan="7" style="text-align: center;">
                                    <em>No borrowers found.</em>
                                </td>
                            </tr>
                        }
                        else
                        {
                            foreach (var bb in allRequests)
                            {
                                <tr>
                                    <td>@bb.BorrowId</td>
                                    <td>@(bb.Patron?.FirstName + " " + bb.Patron?.LastName)</td>
                                    <td>@(bb.Book?.Title ?? "No Title")</td>
                                    <td>@bb.DueDate?.ToString("yyyy-MM-dd")</td>
                                    <td>@bb.Status</td>
                                    <td>
                                        @if (bb.Status == "Overdue")
                                        {
                                        var totaldate = (DateTime.Now - @bb.DueDate)?.Days;
                                        <span class="text-danger">P@((bb.Book?.Subtotal ?? 0) + (10 * totaldate))</span>
                                        }
                                        else
                                        {
                                            <span>P@(bb.Book?.Subtotal ?? 0)</span>
                                        }

                                    </td>
                                @if (ViewBag.IsStudentAssistant == false && bb.Status != "Overdue")
                                    {
                                        <td>
                                            <button class="btn btn-sm btn-success" onclick="returnBook('@bb.BorrowId')">Return</button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="openExtendModal('@bb.BorrowId', '@bb.DueDate')">Extend</button>
                                        </td>
                                    }
                                    else
                                    {
                                        <td>
                                            <button class="btn btn-sm btn-success" onclick="returnBook('@bb.BorrowId')">Return</button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="openExtendModal('@bb.BorrowId', '@bb.DueDate')" disabled>Extend</button>
                                        </td>
                                    }
                                </tr>
                            }
                        }
                    </tbody>
                </table>
        </div>
        <div class="d-flex justify-content-between align-items-center">

            <!-- PAGE INFO LEFT -->
            <div id="pageInfo" class="small text-muted"></div>

            <!-- PAGINATION RIGHT -->
            <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>

        </div>
    </div>
</div>



<br />


<!--popup for extending-->
<div class="modal fade" id="extendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>Extend Due Date</h5></div>
            <div class="modal-body">
                <input type="hidden" id="extendBorrowId" />
                <label class="small fw-bold">New Due Date</label>
                <input type="date" id="newDueDate" class="form-control" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitExtension()">Update Date</button>
            </div>
        </div>
    </div>
</div>




@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
        let rowsPerPage = 10;
        let currentPage = 1;

        function updateTable() {
            let rows = $("#currentBorrowerTable tr:not(.filtered)");
            let totalRows = rows.length;
            let totalPages = Math.ceil(totalRows / rowsPerPage);

            $("#currentBorrowerTable tr").hide();

            let start = (currentPage - 1) * rowsPerPage;
            let end = start + rowsPerPage;

            rows.slice(start, end).show();

            // Page Info
            $("#pageInfo").text(`Showing ${totalRows > 0 ? start + 1 : 0} to ${Math.min(end, totalRows)} of ${totalRows} entries`);

            // Generate Pagination
            let paginationHtml = "";
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>
                                </li>`;
            }
            $("#pagination").html(paginationHtml);
        }

        function goToPage(page) {
            currentPage = page;
            updateTable();
        }

        // Real-time Search
        $("#borrowSearch").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#currentBorrowerTable tr").each(function() {
                let isMatch = $(this).text().toLowerCase().indexOf(value) > -1;
                $(this).toggleClass("filtered", !isMatch);
            });
            currentPage = 1;
            updateTable();
        });

        // Initialize
        $(document).ready(function() {
            updateTable();
        });


       
        function processRequest(url, id) {
            fetch(`${url}?id=${id}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {

                        location.reload();
                    } else {
                        alert("Update failed. Please check the console.");
                    }
                })
                .catch(err => console.error(err));
        }



        function returnBook(id) {
            Swal.fire({
                title: "Confirm Return?",
                text: "This will mark the book as Available again.",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#198754"
            }).then((result) => {
                if (result.isConfirmed) {
                    processRequest('/Book/ReturnBook', id);
                }
            });
        }

        function openExtendModal(id, currentDueDate) {
            document.getElementById('extendBorrowId').value = id;

            if (currentDueDate) {
                document.getElementById('newDueDate').value = currentDueDate.split(' ')[0];
            }
            new bootstrap.Modal(document.getElementById('extendModal')).show();
        }

        function submitExtension() {
            const id = document.getElementById('extendBorrowId').value;
            const newDate = document.getElementById('newDueDate').value;

            if (!newDate) {
                Swal.fire("Error", "Please select a date", "error");
                return;
            }

            fetch(`/Book/ExtendDueDate?id=${id}&newDate=${newDate}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        Swal.fire("Error", "Could not extend date", "error");
                    }
                });
        }
    </script>
    <style>
        .page-link {
            color: #1a2035;
        }

        .page-item.active .page-link {
            background-color: #1a2035;
            border-color: #1a2035;
            color: white;
        }
        .transition-all {
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: #ed1e28 !important;
            background-color: rgba(237, 30, 40, 0.05);
        }

        .active-tab {
            background-color: #1e2953 !important;
            color: white !important;
            box-shadow: 0 4px 10px rgba(30, 41, 83, 0.2);
        }

        .table thead th {
            background-color: #f8f9fa;
            border-top: none;
        }
    </style>

}